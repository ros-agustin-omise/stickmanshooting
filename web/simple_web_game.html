<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stickman Shooting Gallery - Ultra Smooth Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .game-container {
            position: relative;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            background: rgba(0, 0, 0, 0.1);
            padding: 10px;
        }
        
        canvas {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F6FF 70%, #98FB98 100%);
            cursor: crosshair;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: block;
        }
        
        .stickman-container {
            position: absolute;
            top: 13px; /* Account for container padding + border */
            left: 13px;
            pointer-events: none;
            z-index: 10;
        }
        
        .stickman-svg {
            position: absolute;
            width: 60px;
            height: 60px;
            transform-origin: center;
        }
        
        .controls {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .weapon-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .weapon-btn {
            padding: 8px 16px;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }
        
        .weapon-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }
        
        .weapon-btn.active {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
        }
        
        .game-ui {
            text-align: center;
            margin-top: 20px;
        }
        
        .score {
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .instructions {
            font-size: 14px;
            margin-top: 10px;
            opacity: 0.8;
        }
        
        .start-screen, .game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .start-btn, .restart-btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .start-btn:hover, .restart-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(52, 152, 219, 0.4);
        }
        
        .high-scores {
            margin-top: 20px;
            text-align: center;
        }
        
        .input-name {
            padding: 10px;
            margin: 10px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="controls">
        <div class="weapon-buttons">
            <button class="weapon-btn active" data-weapon="pistol">🔫 Pistol (1)</button>
            <button class="weapon-btn" data-weapon="shotgun">💥 Shotgun (2)</button>
            <button class="weapon-btn" data-weapon="rifle">🎯 Rifle (3)</button>
            <button class="weapon-btn" data-weapon="machineGun">⚡ Machine Gun (4)</button>
        </div>
    </div>
    
    <div class="game-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div class="stickman-container" id="stickmanContainer"></div>
        
        <div class="start-screen" id="startScreen">
            <h1 style="font-size: 36px; margin-bottom: 20px;">🎯 Stickman Shooting Gallery</h1>
            <h2 style="font-size: 20px; margin-bottom: 10px;">Ultra Smooth SVG Edition</h2>
            <p style="text-align: center; max-width: 400px;">
                Experience buttery-smooth SVG-powered animations!<br/>
                Advanced keyframe interpolation for realistic movement.<br/>
                Professional-grade stickman physics engine.
            </p>
            <button class="start-btn" onclick="startGame()">🚀 Start Game</button>
        </div>
        
        <div class="game-over-screen" id="gameOverScreen" style="display: none;">
            <h2>🎯 Game Over!</h2>
            <div id="finalScore"></div>
            <input type="text" id="playerName" class="input-name" placeholder="Enter your name" maxlength="15">
            <button class="restart-btn" onclick="restartGame()">🔄 Play Again</button>
            <div class="high-scores" id="highScores"></div>
        </div>
    </div>
    
    <div class="game-ui">
        <div class="score">Score: <span id="scoreDisplay">0</span></div>
        <div class="instructions">
            Move mouse to aim • Click to shoot • Use weapon hotkeys (1-4)
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const stickmanContainer = document.getElementById('stickmanContainer');
        const startScreen = document.getElementById('startScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const scoreDisplay = document.getElementById('scoreDisplay');
        
                 // SVG Stickman Animation Data (inspired by madeindjs/stickman)
         const STICKMAN_ANIMATIONS = {
             running: {
                 duration: 0.6,
                 keyframes: [
                     // Frame 1 - Left foot forward
                     { head: [30, 15], body: [30, 40], armL: [18, 35], armR: [42, 35], legL: [20, 60], legR: [40, 60] },
                     // Frame 2 - Mid stride
                     { head: [30, 14], body: [30, 39], armL: [22, 38], armR: [38, 32], legL: [25, 58], legR: [35, 62] },
                     // Frame 3 - Right foot forward  
                     { head: [30, 15], body: [30, 40], armL: [42, 35], armR: [18, 35], legL: [40, 60], legR: [20, 60] },
                     // Frame 4 - Mid stride opposite
                     { head: [30, 14], body: [30, 39], armL: [38, 32], armR: [22, 38], legL: [35, 62], legR: [25, 58] }
                 ]
             },
             kneeling: {
                duration: 1.0,
                keyframes: [
                    // Frame 1 - Standing upright
                    { head: [30, 15], body: [25, 40], armL: [20, 38], armR: [30, 38], legL: [25, 55], legR: [25, 55] },

                    // Frame 2 - Starting to kneel (right leg bends back)
                    { head: [30, 18], body: [25, 43], armL: [22, 40], armR: [28, 40], legL: [24, 58], legR: [28, 50] },

                    // Frame 3 - Full kneel (right leg bent fully under body)
                    { head: [30, 20], body: [25, 46], armL: [24, 42], armR: [26, 42], legL: [26, 60], legR: [30, 50] },

                    // Frame 4 - Stay kneeling
                    { head: [30, 20], body: [25, 46], armL: [24, 42], armR: [26, 42], legL: [26, 60], legR: [30, 50] }
                ]
            },
             crawling: {
                 duration: 1.0,
                 keyframes: [
                     // Frame 1 - Left arm forward
                     { head: [30, 25], body: [30, 45], armL: [15, 42], armR: [45, 40], legL: [18, 52], legR: [42, 50] },
                     // Frame 2 - Mid crawl
                     { head: [30, 24], body: [30, 44], armL: [20, 40], armR: [40, 42], legL: [22, 50], legR: [38, 52] },
                     // Frame 3 - Right arm forward  
                     { head: [30, 25], body: [30, 45], armL: [45, 40], armR: [15, 42], legL: [42, 50], legR: [18, 52] },
                     // Frame 4 - Back to mid
                     { head: [30, 24], body: [30, 44], armL: [40, 42], armR: [20, 40], legL: [38, 52], legR: [22, 50] }
                 ]
             }
         };
        
        // Game state
        let gameActive = false;
        let score = 0;
        let targets = [];
        let particles = [];
        let animationId;
        let gameTimer;
        let currentWeapon = 'pistol';
        let lastShotTime = 0;
        let mouseX = 0;
        let mouseY = 0;
        
        // Weapon definitions
        const weapons = {
            pistol: { cooldown: 400, damage: 50, color: '#FFD700', pellets: 1 },
            shotgun: { cooldown: 1000, damage: 30, color: '#FF4500', pellets: 5 },
            rifle: { cooldown: 800, damage: 100, color: '#00FF00', pellets: 1 },
            machineGun: { cooldown: 150, damage: 25, color: '#FF00FF', pellets: 1 }
        };
        
        class SVGStickman {
                         constructor(x, y, scale = 1) {
                 this.x = x;
                 this.y = y;
                 this.scale = scale;
                 this.maxHealth = 6; // Fixed health for predictable states
                 this.health = this.maxHealth;
                 this.state = "standing";
                 this.isMoving = Math.random() < 0.8;
                 this.vx = this.isMoving ? (Math.random() < 0.5 ? -0.3 : 0.3) : 0;
                 this.age = 0;
                 this.lifetime = 12000 + Math.random() * 5000; // Much longer lifetime
                 this.active = true;
                 this.fallAngle = 0;
                 this.animationNeedsUpdate = false;
                 
                 this.createElement();
                 this.startAnimation();
             }
            
                         createElement() {
                 this.element = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                 this.element.classList.add('stickman-svg');
                 this.element.setAttribute('viewBox', '0 0 100 120');
                 this.element.setAttribute('width', '120'); // Double the size
                 this.element.setAttribute('height', '160'); // Double the size
                 
                 this.element.innerHTML = `
                     <!-- 3D Cartoon Character: with gradients and shadows -->
                     <defs>
                         <!-- 3D Gradients for depth and lighting -->
                         <radialGradient id="headGradient" cx="0.3" cy="0.3" r="0.8">
                             <stop offset="0%" stop-color="#FFD4CC"/>
                             <stop offset="70%" stop-color="#FDBCB4"/>
                             <stop offset="100%" stop-color="#E09982"/>
                         </radialGradient>
                         <radialGradient id="bodyGradient" cx="0.3" cy="0.2" r="0.9">
                             <stop offset="0%" stop-color="#FF8A5B"/>
                             <stop offset="60%" stop-color="#FF6B35"/>
                             <stop offset="100%" stop-color="#E55A2B"/>
                         </radialGradient>
                         <radialGradient id="armGradient" cx="0.3" cy="0.3" r="0.8">
                             <stop offset="0%" stop-color="#FFD4CC"/>
                             <stop offset="70%" stop-color="#FDBCB4"/>
                             <stop offset="100%" stop-color="#E09982"/>
                         </radialGradient>
                         <radialGradient id="legGradient" cx="0.3" cy="0.2" r="0.9">
                             <stop offset="0%" stop-color="#5A7FFF"/>
                             <stop offset="60%" stop-color="#4169E1"/>
                             <stop offset="100%" stop-color="#2F4F8F"/>
                         </radialGradient>
                         <radialGradient id="shoeGradient" cx="0.3" cy="0.3" r="0.8">
                             <stop offset="0%" stop-color="#FFFFFF"/>
                             <stop offset="70%" stop-color="#F0F0F0"/>
                             <stop offset="100%" stop-color="#CCCCCC"/>
                         </radialGradient>
                         <radialGradient id="hairGradient" cx="0.3" cy="0.2" r="0.9">
                             <stop offset="0%" stop-color="#A0693D"/>
                             <stop offset="60%" stop-color="#8B4513"/>
                             <stop offset="100%" stop-color="#654321"/>
                         </radialGradient>
                         
                         <!-- Drop shadow filter -->
                         <filter id="dropShadow" x="-50%" y="-50%" width="200%" height="200%">
                             <feDropShadow dx="2" dy="3" stdDeviation="2" flood-color="#000000" flood-opacity="0.3"/>
                         </filter>
                     </defs>
                     
                     <g stroke-linecap="round" stroke-linejoin="round">
                         <!-- Head/Face with 3D gradient and shadow -->
                         <circle id="head" cx="50" cy="14" r="8" fill="url(#headGradient)" stroke="#E09982" stroke-width="1" filter="url(#dropShadow)"/>
                         
                         <!-- Head highlight for 3D effect -->
                         <ellipse cx="47" cy="11" rx="3" ry="4" fill="rgba(255,255,255,0.4)" stroke="none"/>
                         
                         <!-- Hair with 3D gradient -->
                         <ellipse cx="50" cy="8" rx="9" ry="4" fill="url(#hairGradient)" stroke="#654321" stroke-width="1" filter="url(#dropShadow)"/>
                         <ellipse cx="42" cy="10" rx="2" ry="3" fill="url(#hairGradient)" stroke="none"/>
                         <ellipse cx="58" cy="10" rx="2" ry="3" fill="url(#hairGradient)" stroke="none"/>
                         
                         <!-- Hair highlights -->
                         <ellipse cx="47" cy="6" rx="4" ry="1.5" fill="rgba(255,255,255,0.2)" stroke="none"/>
                         
                         <!-- Eyes with depth -->
                         <ellipse cx="47" cy="12" rx="1.8" ry="2.2" fill="#FFFFFF" stroke="#999999" stroke-width="0.3"/>
                         <ellipse cx="53" cy="12" rx="1.8" ry="2.2" fill="#FFFFFF" stroke="#999999" stroke-width="0.3"/>
                         <ellipse cx="47" cy="12.2" rx="1.2" ry="1.5" fill="#000000" stroke="none"/>
                         <ellipse cx="53" cy="12.2" rx="1.2" ry="1.5" fill="#000000" stroke="none"/>
                         <!-- Eye shine enhanced -->
                         <ellipse cx="47.5" cy="11.3" rx="0.6" ry="0.9" fill="rgba(255,255,255,0.9)" stroke="none"/>
                         <ellipse cx="53.5" cy="11.3" rx="0.6" ry="0.9" fill="rgba(255,255,255,0.9)" stroke="none"/>
                         
                         <!-- 3D Mouth -->
                         <ellipse cx="50" cy="16.2" rx="1.8" ry="1" fill="#DD2222" stroke="#CC0000" stroke-width="0.5" filter="url(#dropShadow)"/>
                         <ellipse cx="49.5" cy="15.8" rx="1" ry="0.5" fill="rgba(255,100,100,0.6)" stroke="none"/>
                         
                         <!-- 3D Shirt (body) -->
                         <ellipse id="body" cx="50" cy="31" rx="6" ry="12" fill="url(#bodyGradient)" stroke="#E55A2B" stroke-width="1" filter="url(#dropShadow)"/>
                         <!-- Body highlight -->
                         <ellipse cx="47" cy="26" rx="3" ry="8" fill="rgba(255,255,255,0.25)" stroke="none"/>
                         
                         <!-- 3D Shirt collar -->
                         <ellipse cx="50" cy="21" rx="4" ry="2" fill="#CC5429" stroke="#A04220" stroke-width="0.5"/>
                         <ellipse cx="49" cy="20.5" rx="2" ry="1" fill="rgba(255,255,255,0.3)" stroke="none"/>
                         
                         <!-- 3D Shirt buttons -->
                         <circle cx="50" cy="26" r="1" fill="#AA3A1F" stroke="#883015" stroke-width="0.3"/>
                         <circle cx="49.5" cy="25.5" r="0.4" fill="rgba(255,255,255,0.5)" stroke="none"/>
                         <circle cx="50" cy="30" r="1" fill="#AA3A1F" stroke="#883015" stroke-width="0.3"/>
                         <circle cx="49.5" cy="29.5" r="0.4" fill="rgba(255,255,255,0.5)" stroke="none"/>
                         <circle cx="50" cy="34" r="1" fill="#AA3A1F" stroke="#883015" stroke-width="0.3"/>
                         <circle cx="49.5" cy="33.5" r="0.4" fill="rgba(255,255,255,0.5)" stroke="none"/>
                         
                         <!-- 3D Left Arm -->
                         <ellipse id="armL1" cx="39" cy="27" rx="3" ry="8" fill="url(#bodyGradient)" stroke="#E55A2B" stroke-width="1" transform="rotate(-15 39 27)" filter="url(#dropShadow)"/>
                         <ellipse id="armL2" cx="33" cy="36" rx="2.5" ry="6" fill="url(#armGradient)" stroke="#E09982" stroke-width="1" transform="rotate(-10 33 36)" filter="url(#dropShadow)"/>
                         <circle id="handL" cx="30" cy="42" r="2.5" fill="url(#armGradient)" stroke="#E09982" stroke-width="1" filter="url(#dropShadow)"/>
                         <!-- Left hand highlight -->
                         <ellipse cx="29" cy="41" rx="1" ry="1.5" fill="rgba(255,255,255,0.4)" stroke="none"/>
                         
                         <!-- 3D Right Arm -->
                         <ellipse id="armR1" cx="61" cy="27" rx="3" ry="8" fill="url(#bodyGradient)" stroke="#E55A2B" stroke-width="1" transform="rotate(15 61 27)" filter="url(#dropShadow)"/>
                         <ellipse id="armR2" cx="67" cy="36" rx="2.5" ry="6" fill="url(#armGradient)" stroke="#E09982" stroke-width="1" transform="rotate(10 67 36)" filter="url(#dropShadow)"/>
                         <circle id="handR" cx="70" cy="42" r="2.5" fill="url(#armGradient)" stroke="#E09982" stroke-width="1" filter="url(#dropShadow)"/>
                         <!-- Right hand highlight -->
                         <ellipse cx="69" cy="41" rx="1" ry="1.5" fill="rgba(255,255,255,0.4)" stroke="none"/>
                         
                         <!-- 3D Belt -->
                         <ellipse cx="50" cy="41" rx="6" ry="1.5" fill="#8B4513" stroke="#654321" stroke-width="1" filter="url(#dropShadow)"/>
                         <ellipse cx="49" cy="40.5" rx="4" ry="0.8" fill="rgba(255,255,255,0.2)" stroke="none"/>
                         <ellipse cx="50" cy="41" rx="1.8" ry="1.2" fill="#FFD700" stroke="#FFA500" stroke-width="0.3"/>
                         <ellipse cx="49.5" cy="40.5" rx="0.8" ry="0.6" fill="rgba(255,255,255,0.6)" stroke="none"/>
                         
                         <!-- 3D Jeans -->
                         <ellipse id="legL1" cx="47" cy="52" rx="3" ry="10" fill="url(#legGradient)" stroke="#2F4F8F" stroke-width="1" filter="url(#dropShadow)"/>
                         <ellipse id="legL2" cx="46" cy="66" rx="2.5" ry="7" fill="url(#legGradient)" stroke="#2F4F8F" stroke-width="1" filter="url(#dropShadow)"/>
                         <!-- Left leg highlight -->
                         <ellipse cx="45.5" cy="48" rx="1.5" ry="6" fill="rgba(255,255,255,0.15)" stroke="none"/>
                         
                         <ellipse id="legR1" cx="53" cy="52" rx="3" ry="10" fill="url(#legGradient)" stroke="#2F4F8F" stroke-width="1" filter="url(#dropShadow)"/>
                         <ellipse id="legR2" cx="54" cy="66" rx="2.5" ry="7" fill="url(#legGradient)" stroke="#2F4F8F" stroke-width="1" filter="url(#dropShadow)"/>
                         <!-- Right leg highlight -->
                         <ellipse cx="51.5" cy="48" rx="1.5" ry="6" fill="rgba(255,255,255,0.15)" stroke="none"/>
                         
                         <!-- 3D Sneakers -->
                         <ellipse id="footL" cx="44" cy="74" rx="4" ry="2.5" fill="url(#shoeGradient)" stroke="#CCCCCC" stroke-width="1" filter="url(#dropShadow)"/>
                         <ellipse cx="44" cy="74" rx="4" ry="1.2" fill="#FF0000" stroke="#CC0000" stroke-width="0.3"/>
                         <ellipse cx="42" cy="73" rx="2" ry="1" fill="rgba(255,255,255,0.5)" stroke="none"/>
                         
                         <ellipse id="footR" cx="56" cy="74" rx="4" ry="2.5" fill="url(#shoeGradient)" stroke="#CCCCCC" stroke-width="1" filter="url(#dropShadow)"/>
                         <ellipse cx="56" cy="74" rx="4" ry="1.2" fill="#FF0000" stroke="#CC0000" stroke-width="0.3"/>
                         <ellipse cx="54" cy="73" rx="2" ry="1" fill="rgba(255,255,255,0.5)" stroke="none"/>
                         
                         <!-- 3D Backpack straps -->
                         <ellipse cx="45" cy="32" rx="0.8" ry="8" fill="#654321" stroke="#4A2F2F" stroke-width="0.3" filter="url(#dropShadow)"/>
                         <ellipse cx="44.5" cy="28" rx="0.4" ry="4" fill="rgba(255,255,255,0.2)" stroke="none"/>
                         <ellipse cx="55" cy="32" rx="0.8" ry="8" fill="#654321" stroke="#4A2F2F" stroke-width="0.3" filter="url(#dropShadow)"/>
                         <ellipse cx="54.5" cy="28" rx="0.4" ry="4" fill="rgba(255,255,255,0.2)" stroke="none"/>
                     </g>
                     
                     <!-- Health Bar -->
                     <g id="healthBar">
                         <rect x="20" y="2" width="60" height="6" fill="rgba(0,0,0,0.6)" rx="3"/>
                         <rect id="health-fill" x="20" y="2" width="60" height="6" fill="#27ae60" rx="3"/>
                     </g>
                 `;
                 
                 this.updatePosition();
                 stickmanContainer.appendChild(this.element);
             }
            
                         startAnimation() {
                 this.updateAnimation();
             }
             
             updateAnimation() {
                 if (!this.element) return;
                 
                 // Clear any existing animations first
                 this.clearAnimations();
                 
                 let duration, animationType;
                 
                 // Choose animation based on state and movement
                 if (this.state === 'crawling') {
                     duration = 1200; // 1.2 seconds
                     animationType = 'crawling';
                 } else if (this.state === 'kneeling') {
                     duration = 1000; // 1 second
                     animationType = 'kneeling';
                 } else if (this.isMoving) {
                     duration = 800; // 0.8 seconds  
                     animationType = 'running';
                 } else {
                     // Standing still
                     return;
                 }
                 
                 this.startJSAnimation(animationType, duration);
             }
             
             startJSAnimation(type, duration) {
                 // Cancel any existing animation
                 if (this.animationTimer) {
                     clearInterval(this.animationTimer);
                 }
                 
                 const frames = 60; // frames per second
                 const totalFrames = (duration / 1000) * frames;
                 let currentFrame = 0;
                 
                 this.animationTimer = setInterval(() => {
                     currentFrame = (currentFrame + 1) % totalFrames;
                     const progress = currentFrame / totalFrames;
                     
                     this.updateStickmanPose(type, progress);
                 }, 1000 / frames);
             }
             
             updateStickmanPose(type, progress) {
                 if (!this.element) return;
                 
                 // Get game sprite elements (now using rectangles)
                 const head = this.element.querySelector('#head');
                 const body = this.element.querySelector('#body');
                 const armL1 = this.element.querySelector('#armL1');
                 const armL2 = this.element.querySelector('#armL2');
                 const armR1 = this.element.querySelector('#armR1');
                 const armR2 = this.element.querySelector('#armR2');
                 const handL = this.element.querySelector('#handL');
                 const handR = this.element.querySelector('#handR');
                 const legL1 = this.element.querySelector('#legL1');
                 const legL2 = this.element.querySelector('#legL2');
                 const legR1 = this.element.querySelector('#legR1');
                 const legR2 = this.element.querySelector('#legR2');
                 const footL = this.element.querySelector('#footL');
                 const footR = this.element.querySelector('#footR');
                 
                 if (!head || !body || !armL1 || !armL2 || !armR1 || !armR2 || !legL1 || !legL2 || !legR1 || !legR2 || !footL || !footR) return;
                 
                 const cycle = progress * 2 * Math.PI;
                 
                 if (type === 'running') {
                     // Cartoon character running animation
                     const step = Math.sin(cycle) * 2;
                     const armSwing = Math.sin(cycle) * 1.5;
                     const headBob = Math.sin(cycle * 2) * 0.5;
                     
                     // Reset to front-facing view (circles use cx/cy)
                     head.setAttribute('cx', 50);
                     head.setAttribute('r', 8);
                     body.setAttribute('cx', 50);
                     body.setAttribute('rx', 6);
                     body.setAttribute('ry', 12);
                     
                     // Show front-facing features and hide side profile
                     const frontEyes = this.element.querySelectorAll('ellipse[cx="47"], ellipse[cx="53"]');
                     const eyeShines = this.element.querySelectorAll('ellipse[cx="47.5"], ellipse[cx="53.5"]');
                     const frontMouth = this.element.querySelector('ellipse[cx="50"][cy="16"]');
                     frontEyes.forEach(eye => eye.style.display = 'block');
                     eyeShines.forEach(shine => shine.style.display = 'block');
                     if (frontMouth) frontMouth.style.display = 'block';
                     
                     const sideFeatures = this.element.querySelectorAll('#sideEye, #sideNose, #sideMouth');
                     sideFeatures.forEach(feature => feature.style.display = 'none');
                     
                     // Show front-facing shirt details and hide side profile shirt
                     const frontShirtElements = this.element.querySelectorAll('ellipse[cx="50"][cy="21"], circle[cx="50"][cy="26"], circle[cx="50"][cy="30"], circle[cx="50"][cy="34"]');
                     frontShirtElements.forEach(el => el.style.display = 'block');
                     
                     const sideShirtElements = this.element.querySelectorAll('#sideShirtCollar, #sideShirtLine');
                     sideShirtElements.forEach(el => el.style.display = 'none');
                     
                     // Hide top-down shirt elements
                     const topShirtElements = this.element.querySelectorAll('#topShirtPattern, #topShirtSeam');
                     topShirtElements.forEach(el => el.style.display = 'none');
                     
                     // Reset arm dimensions (ellipses use rx/ry)
                     armL1.setAttribute('rx', 3);
                     armL1.setAttribute('ry', 8);
                     armL2.setAttribute('rx', 2.5);
                     armL2.setAttribute('ry', 6);
                     handL.setAttribute('r', 2.5);
                     armR1.setAttribute('rx', 3);
                     armR1.setAttribute('ry', 8);
                     armR2.setAttribute('rx', 2.5);
                     armR2.setAttribute('ry', 6);
                     handR.setAttribute('r', 2.5);
                     
                     // Reset leg dimensions
                     legL1.setAttribute('rx', 3);
                     legL1.setAttribute('ry', 10);
                     legL2.setAttribute('rx', 2.5);
                     legL2.setAttribute('ry', 7);
                     legR1.setAttribute('rx', 3);
                     legR1.setAttribute('ry', 10);
                     legR2.setAttribute('rx', 2.5);
                     legR2.setAttribute('ry', 7);
                     
                     // Reset foot dimensions
                     footL.setAttribute('rx', 4);
                     footL.setAttribute('ry', 2.5);
                     footR.setAttribute('rx', 4);
                     footR.setAttribute('ry', 2.5);
                     
                     // Head with subtle bob
                     head.setAttribute('cy', 14 + headBob);
                     
                     // Body stays mostly centered
                     body.setAttribute('cy', 31 + headBob * 0.3);
                     
                     // Left arm swing
                     const leftArmPhase = Math.sin(cycle + Math.PI) * armSwing;
                     armL1.setAttribute('cx', 39 + leftArmPhase);
                     armL2.setAttribute('cx', 33 + leftArmPhase * 1.2);
                     handL.setAttribute('cx', 30 + leftArmPhase * 1.2);
                     
                     // Right arm swing (opposite to left)
                     const rightArmPhase = Math.sin(cycle) * armSwing;
                     armR1.setAttribute('cx', 61 + rightArmPhase);
                     armR2.setAttribute('cx', 67 + rightArmPhase * 1.2);
                     handR.setAttribute('cx', 70 + rightArmPhase * 1.2);
                     
                     // Left leg stepping
                     const leftLegPhase = Math.sin(cycle) * step;
                     legL1.setAttribute('cx', 47 + leftLegPhase * 0.5);
                     legL2.setAttribute('cx', 46 + leftLegPhase * 0.7);
                     legL2.setAttribute('cy', 66 - Math.abs(leftLegPhase) * 0.3);
                     
                     // Right leg stepping (opposite to left)
                     const rightLegPhase = Math.sin(cycle + Math.PI) * step;
                     legR1.setAttribute('cx', 53 + rightLegPhase * 0.5);
                     legR2.setAttribute('cx', 54 + rightLegPhase * 0.7);
                     legR2.setAttribute('cy', 66 - Math.abs(rightLegPhase) * 0.3);
                     
                     // Move feet with legs
                     footL.setAttribute('cx', 44 + leftLegPhase * 0.7);
                     footL.setAttribute('cy', 74 - Math.abs(leftLegPhase) * 0.1);
                     footR.setAttribute('cx', 56 + rightLegPhase * 0.7);
                     footR.setAttribute('cy', 74 - Math.abs(rightLegPhase) * 0.1);
                     
                 } else if (type === 'kneeling') {
                     // Kneeling cartoon pose - side view with rocking motion
                     const breathe = Math.sin(progress * 4 * Math.PI) * 0.8; // Breathing
                     const rock = Math.sin(progress * 2 * Math.PI) * 2.5; // Front-back rocking motion
                     
                     // Head in profile view with breathing and rocking motion
                     head.setAttribute('cx', 48 + rock * 0.3); // Rocks with body
                     head.setAttribute('cy', 14 + breathe);
                     head.setAttribute('rx', 5); // Narrower for side view
                     head.setAttribute('ry', 8);
                     
                     // Hide front-facing eyes, shines and mouth
                     const frontEyes = this.element.querySelectorAll('ellipse[cx="47"], ellipse[cx="53"]');
                     const eyeShines = this.element.querySelectorAll('ellipse[cx="47.5"], ellipse[cx="53.5"]');
                     const frontMouth = this.element.querySelector('ellipse[cx="50"][cy="16"]');
                     frontEyes.forEach(eye => eye.style.display = 'none');
                     eyeShines.forEach(shine => shine.style.display = 'none');
                     if (frontMouth) frontMouth.style.display = 'none';
                     
                     // Add side profile features if they don't exist
                     if (!this.element.querySelector('#sideEye')) {
                         const sideEye = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
                         sideEye.setAttribute('id', 'sideEye');
                         sideEye.setAttribute('cx', '50');
                         sideEye.setAttribute('cy', '14');
                         sideEye.setAttribute('rx', '1.2');
                         sideEye.setAttribute('ry', '1.8');
                         sideEye.setAttribute('fill', '#000000');
                         this.element.querySelector('g').appendChild(sideEye);
                         
                         const sideNose = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
                         sideNose.setAttribute('id', 'sideNose');
                         sideNose.setAttribute('cx', '53');
                         sideNose.setAttribute('cy', '15');
                         sideNose.setAttribute('rx', '1');
                         sideNose.setAttribute('ry', '0.8');
                         sideNose.setAttribute('fill', '#E09982');
                         this.element.querySelector('g').appendChild(sideNose);
                         
                         const sideMouth = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
                         sideMouth.setAttribute('id', 'sideMouth');
                         sideMouth.setAttribute('cx', '51');
                         sideMouth.setAttribute('cy', '17');
                         sideMouth.setAttribute('rx', '0.8');
                         sideMouth.setAttribute('ry', '0.5');
                         sideMouth.setAttribute('fill', '#FF4444');
                         this.element.querySelector('g').appendChild(sideMouth);
                     }
                     
                     // Update side features position with breathing and rocking
                     const sideEye = this.element.querySelector('#sideEye');
                     const sideNose = this.element.querySelector('#sideNose');
                     const sideMouth = this.element.querySelector('#sideMouth');
                     if (sideEye) {
                         sideEye.setAttribute('cx', 50 + rock * 0.3);
                         sideEye.setAttribute('cy', 14 + breathe);
                     }
                     if (sideNose) {
                         sideNose.setAttribute('cx', 53 + rock * 0.3);
                         sideNose.setAttribute('cy', 15 + breathe);
                     }
                     if (sideMouth) {
                         sideMouth.setAttribute('cx', 51 + rock * 0.3);
                         sideMouth.setAttribute('cy', 17 + breathe);
                     }
                     
                     // Body in profile, rocking forward and back
                     body.setAttribute('cx', 48 + rock * 0.4); // Rocks with whole body
                     body.setAttribute('cy', 31 + breathe * 0.5); // Breathing movement
                     body.setAttribute('rx', 4); // Narrower body for side view
                     body.setAttribute('ry', 12);
                     
                     // Hide front-facing shirt details and add side profile shirt
                     const frontShirtElements = this.element.querySelectorAll('ellipse[cx="50"][cy="21"], circle[cx="50"][cy="26"], circle[cx="50"][cy="30"], circle[cx="50"][cy="34"]');
                     frontShirtElements.forEach(el => el.style.display = 'none');
                     
                     // Add side profile shirt details if they don't exist
                     if (!this.element.querySelector('#sideShirtCollar')) {
                         const sideCollar = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
                         sideCollar.setAttribute('id', 'sideShirtCollar');
                         sideCollar.setAttribute('cx', '48');
                         sideCollar.setAttribute('cy', '21');
                         sideCollar.setAttribute('rx', '4');
                         sideCollar.setAttribute('ry', '1.5');
                         sideCollar.setAttribute('fill', '#CC5429');
                         this.element.querySelector('g').appendChild(sideCollar);
                         
                         const sideShirtLine = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
                         sideShirtLine.setAttribute('id', 'sideShirtLine');
                         sideShirtLine.setAttribute('cx', '51');
                         sideShirtLine.setAttribute('cy', '31');
                         sideShirtLine.setAttribute('rx', '0.5');
                         sideShirtLine.setAttribute('ry', '8');
                         sideShirtLine.setAttribute('fill', '#CC5429');
                         this.element.querySelector('g').appendChild(sideShirtLine);
                     }
                     
                     // Update side shirt elements with breathing and rocking
                     const sideCollar = this.element.querySelector('#sideShirtCollar');
                     const sideShirtLine = this.element.querySelector('#sideShirtLine');
                     if (sideCollar) {
                         sideCollar.setAttribute('cx', 48 + rock * 0.4);
                         sideCollar.setAttribute('cy', 21 + breathe * 0.5);
                     }
                     if (sideShirtLine) {
                         sideShirtLine.setAttribute('cx', 51 + rock * 0.4);
                         sideShirtLine.setAttribute('cy', 31 + breathe * 0.5);
                     }
                     
                     // Hide top-down shirt elements
                     const topShirtElements = this.element.querySelectorAll('#topShirtPattern, #topShirtSeam');
                     topShirtElements.forEach(el => el.style.display = 'none');
                     
                     // Left arm (back arm, reaching to floor) with rocking motion
                     armL1.setAttribute('cx', 44 + rock * 0.2);
                     armL1.setAttribute('cy', 32 + breathe * 0.2);
                     armL1.setAttribute('rx', 2.5); // Upper arm angled down
                     armL1.setAttribute('ry', 8);
                     armL2.setAttribute('cx', 38 + rock * 0.8); // Forearm extends to floor
                     armL2.setAttribute('cy', 50 + breathe * 0.2);
                     armL2.setAttribute('rx', 2);
                     armL2.setAttribute('ry', 8);
                     handL.setAttribute('cx', 32 + rock); // Hand on floor, rocks front/back
                     handL.setAttribute('cy', 58 + breathe * 0.1); // Hand on ground level
                     handL.setAttribute('r', 2.5);
                     
                     // Right arm (front arm, also reaching to floor) with rocking motion
                     armR1.setAttribute('cx', 52 + rock * 0.2);
                     armR1.setAttribute('cy', 32 + breathe * 0.2);
                     armR1.setAttribute('rx', 3); // Upper arm angled down
                     armR1.setAttribute('ry', 8);
                     armR2.setAttribute('cx', 58 + rock * 0.8); // Forearm extends to floor
                     armR2.setAttribute('cy', 50 + breathe * 0.2);
                     armR2.setAttribute('rx', 2.5);
                     armR2.setAttribute('ry', 8);
                     handR.setAttribute('cx', 64 + rock); // Hand on floor, rocks front/back
                     handR.setAttribute('cy', 58 + breathe * 0.1); // Hand on ground level
                     handR.setAttribute('r', 3);
                     
                     // Left leg (kneeling leg, rocks with body) with breathing motion
                     legL1.setAttribute('cx', 47 + rock * 0.3);
                     legL1.setAttribute('cy', 54 + breathe * 0.4);
                     legL1.setAttribute('rx', 2.5);
                     legL1.setAttribute('ry', 12); // Longer for kneeling position
                     legL2.setAttribute('cx', 46 + rock * 0.5); // Shin rocks more
                     legL2.setAttribute('cy', 70 + breathe * 0.4);
                     legL2.setAttribute('rx', 2);
                     legL2.setAttribute('ry', 4); // Shorter shin
                     
                     // Right leg (forward leg, bent at knee) with rocking motion
                     legR1.setAttribute('cx', 52 + rock * 0.3);
                     legR1.setAttribute('cy', 48 + breathe * 0.4);
                     legR1.setAttribute('rx', 2.5);
                     legR1.setAttribute('ry', 10);
                     legR2.setAttribute('cx', 56 + rock * 0.5); // Shin rocks more
                     legR2.setAttribute('cy', 60 + breathe * 0.4);
                     legR2.setAttribute('rx', 2);
                     legR2.setAttribute('ry', 6);
                     
                     // Feet positions (side view) with rocking motion
                     footL.setAttribute('cx', 44 + rock * 0.6); // Feet rock with legs
                     footL.setAttribute('cy', 76 + breathe * 0.4);
                     footL.setAttribute('rx', 3); // Narrower for side view
                     footL.setAttribute('ry', 2);
                     footR.setAttribute('cx', 58 + rock * 0.6); // Feet rock with legs
                     footR.setAttribute('cy', 68 + breathe * 0.4);
                     footR.setAttribute('rx', 4); // More visible front foot
                     footR.setAttribute('ry', 2.5);
                     
                 } else if (type === 'crawling') {
                     // Crawling cartoon animation - top-down view
                     const crawlCycle = cycle * 0.5;
                     const elbowPush = Math.sin(crawlCycle) * 1.5;
                     
                     // Head from top-down view (showing hair/top of head)
                     head.setAttribute('cx', 50);
                     head.setAttribute('cy', 18);
                     head.setAttribute('r', 7); // Slightly smaller for top-down perspective
                     
                     // Body from top-down view (wider, flatter)
                     body.setAttribute('cx', 50);
                     body.setAttribute('cy', 32);
                     body.setAttribute('rx', 8); // Wider from above
                     body.setAttribute('ry', 10); // Shorter from top-down
                     
                     // Hide all facial features for top-down view
                     const frontEyes = this.element.querySelectorAll('ellipse[cx="47"], ellipse[cx="53"]');
                     const eyeShines = this.element.querySelectorAll('ellipse[cx="47.5"], ellipse[cx="53.5"]');
                     const frontMouth = this.element.querySelector('ellipse[cx="50"][cy="16"]');
                     frontEyes.forEach(eye => eye.style.display = 'none');
                     eyeShines.forEach(shine => shine.style.display = 'none');
                     if (frontMouth) frontMouth.style.display = 'none';
                     
                     const sideFeatures = this.element.querySelectorAll('#sideEye, #sideNose, #sideMouth');
                     sideFeatures.forEach(feature => feature.style.display = 'none');
                     
                     // Hide shirt details and show top-down shirt view
                     const frontShirtElements = this.element.querySelectorAll('ellipse[cx="50"][cy="21"], circle[cx="50"][cy="26"], circle[cx="50"][cy="30"], circle[cx="50"][cy="34"]');
                     frontShirtElements.forEach(el => el.style.display = 'none');
                     
                     const sideShirtElements = this.element.querySelectorAll('#sideShirtCollar, #sideShirtLine');
                     sideShirtElements.forEach(el => el.style.display = 'none');
                     
                     // Add top-down shirt details if they don't exist
                     if (!this.element.querySelector('#topShirtPattern')) {
                         const topShirtPattern = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
                         topShirtPattern.setAttribute('id', 'topShirtPattern');
                         topShirtPattern.setAttribute('cx', '50');
                         topShirtPattern.setAttribute('cy', '28');
                         topShirtPattern.setAttribute('rx', '6');
                         topShirtPattern.setAttribute('ry', '3');
                         topShirtPattern.setAttribute('fill', '#CC5429');
                         this.element.querySelector('g').appendChild(topShirtPattern);
                         
                         const topShirtSeam = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
                         topShirtSeam.setAttribute('id', 'topShirtSeam');
                         topShirtSeam.setAttribute('cx', '50');
                         topShirtSeam.setAttribute('cy', '35');
                         topShirtSeam.setAttribute('rx', '7');
                         topShirtSeam.setAttribute('ry', '1');
                         topShirtSeam.setAttribute('fill', '#CC5429');
                         this.element.querySelector('g').appendChild(topShirtSeam);
                     }
                     
                     // Show top-down shirt elements
                     const topShirtElements = this.element.querySelectorAll('#topShirtPattern, #topShirtSeam');
                     topShirtElements.forEach(el => el.style.display = 'block');
                     
                     // Top-down arm dimensions (flatter, wider for perspective)
                     armL1.setAttribute('rx', 6); // Wider from above
                     armL1.setAttribute('ry', 3); // Flatter from above
                     armL2.setAttribute('rx', 5);
                     armL2.setAttribute('ry', 2.5);
                     handL.setAttribute('r', 3);
                     armR1.setAttribute('rx', 6);
                     armR1.setAttribute('ry', 3);
                     armR2.setAttribute('rx', 5);
                     armR2.setAttribute('ry', 2.5);
                     handR.setAttribute('r', 3);
                     
                     // Top-down leg dimensions (flatter, wider)
                     legL1.setAttribute('rx', 5); // Wider from above
                     legL1.setAttribute('ry', 3); // Much flatter
                     legL2.setAttribute('rx', 4);
                     legL2.setAttribute('ry', 2.5);
                     legR1.setAttribute('rx', 5);
                     legR1.setAttribute('ry', 3);
                     legR2.setAttribute('rx', 4);
                     legR2.setAttribute('ry', 2.5);
                     
                     // Top-down foot dimensions (oval, flat)
                     footL.setAttribute('rx', 3);
                     footL.setAttribute('ry', 5); // Longer in crawling direction
                     footR.setAttribute('rx', 3);
                     footR.setAttribute('ry', 5);
                     
                     // Arms spread out horizontally (crawling motion from above)
                     const leftElbowPhase = Math.sin(crawlCycle) * elbowPush;
                     const rightElbowPhase = Math.sin(crawlCycle + Math.PI) * elbowPush;
                     
                     // Left arm extending outward from body
                     armL1.setAttribute('cx', 35 + leftElbowPhase);
                     armL1.setAttribute('cy', 28);
                     armL2.setAttribute('cx', 28 + leftElbowPhase * 1.2);
                     armL2.setAttribute('cy', 28);
                     handL.setAttribute('cx', 22 + leftElbowPhase * 1.2);
                     handL.setAttribute('cy', 28);
                     
                     // Right arm extending outward from body
                     armR1.setAttribute('cx', 65 + rightElbowPhase);
                     armR1.setAttribute('cy', 28);
                     armR2.setAttribute('cx', 72 + rightElbowPhase * 1.2);
                     armR2.setAttribute('cy', 28);
                     handR.setAttribute('cx', 78 + rightElbowPhase * 1.2);
                     handR.setAttribute('cy', 28);
                     
                     // Legs spread out behind (crawling from above)
                     const legDrag = Math.sin(crawlCycle * 0.3) * 0.8;
                     
                     legL1.setAttribute('cx', 46 + legDrag);
                     legL1.setAttribute('cy', 46);
                     legL2.setAttribute('cx', 44 + legDrag);
                     legL2.setAttribute('cy', 58);
                     
                     legR1.setAttribute('cx', 54 - legDrag);
                     legR1.setAttribute('cy', 46);
                     legR2.setAttribute('cx', 56 - legDrag);
                     legR2.setAttribute('cy', 58);
                     
                     // Feet trailing behind
                     footL.setAttribute('cx', 42 + legDrag);
                     footL.setAttribute('cy', 68);
                     footR.setAttribute('cx', 58 - legDrag);
                     footR.setAttribute('cy', 68);
                 }
             }
             
             clearAnimations() {
                 if (this.animationTimer) {
                     clearInterval(this.animationTimer);
                     this.animationTimer = null;
                 }
             }
             
             createDeathScatterEffect() {
                 // Create dramatic body part scatter effect
                 const centerX = this.x + 30;
                 const centerY = this.y + 35;
                 
                 // Create "body parts" particles with different colors and shapes
                 const bodyParts = [
                     { color: '#8B0000', size: 6, name: 'torso' },
                     { color: '#A52A2A', size: 4, name: 'head' },
                     { color: '#DC143C', size: 3, name: 'arm1' },
                     { color: '#DC143C', size: 3, name: 'arm2' },
                     { color: '#B22222', size: 4, name: 'leg1' },
                     { color: '#B22222', size: 4, name: 'leg2' }
                 ];
                 
                 bodyParts.forEach((part, index) => {
                     for (let i = 0; i < 3; i++) { // 3 particles per body part
                         const angle = (index * Math.PI / 3) + (Math.random() - 0.5) * Math.PI;
                         const speed = 3 + Math.random() * 4;
                         const vx = Math.cos(angle) * speed;
                         const vy = Math.sin(angle) * speed - Math.random() * 2;
                         
                         particles.push(new Particle(
                             centerX + (Math.random() - 0.5) * 20,
                             centerY + (Math.random() - 0.5) * 20,
                             vx, vy, part.color, 120
                         ));
                     }
                 });
                 
                 // Create additional blood splatter
                 const bloodColors = ['#8B0000', '#A52A2A', '#B22222', '#DC143C'];
                 for (let i = 0; i < 15; i++) {
                     const angle = Math.random() * Math.PI * 2;
                     const speed = 2 + Math.random() * 5;
                     const vx = Math.cos(angle) * speed;
                     const vy = Math.sin(angle) * speed - Math.random() * 3;
                     const color = bloodColors[Math.floor(Math.random() * bloodColors.length)];
                     
                     particles.push(new Particle(centerX, centerY, vx, vy, color, 100));
                 }
             }
             
             stopAnimation() {
                 this.clearAnimations();
             }
            
                         updatePosition() {
                 if (!this.element) return;
                 this.element.style.left = this.x + 'px';
                 this.element.style.top = this.y + 'px';
                 
                 // Apply rotation based on state
                 let rotation = 0;
                 if (this.state === 'crawling') {
                     rotation = 90; // 90 degree angle (horizontal) for crawling
                 } else if (this.state === 'falling') {
                     rotation = this.fallAngle; // Dynamic falling rotation
                 }
                 // Note: kneeling now uses natural floor-kneeling pose (no rotation needed)
                 
                 this.element.style.transform = `scale(${this.scale}) rotate(${rotation}deg)`;
             }
            
                         updateHealthBar() {
                 const healthPercent = this.health / this.maxHealth;
                 const healthBar = this.element.querySelector('#health-fill');
                 if (healthBar) {
                     // Scale health bar width to simple coordinate system
                     healthBar.setAttribute('width', (60 * healthPercent).toString());
                 }
                 
                 // Update health bar color (stays colorful for visibility)
                 if (healthBar) {
                     const barColor = healthPercent > 0.66 ? '#27ae60' : 
                                     healthPercent > 0.33 ? '#f39c12' : '#e74c3c';
                     healthBar.setAttribute('fill', barColor);
                 }
                 
                 // Trigger animation update since health changed
                 this.animationNeedsUpdate = true;
             }
            
                         update() {
                 if (!this.active) return;
                 
                 this.age += 16;
                 
                 // Store previous state
                 const prevState = this.state;
                 
                 // Update health-based state transitions  
                 const healthPercent = this.health / this.maxHealth;
                 if (this.health > 0) {
                     // 6 health -> 4 health (66%) = kneeling
                     // 4 health -> 2 health (33%) = crawling  
                     if (this.health <= 2 && this.state !== "crawling") {
                         console.log(`Transition to crawling: ${this.health}/${this.maxHealth}`);
                         this.state = "crawling";
                     } else if (this.health <= 4 && this.state === "standing") {
                         console.log(`Transition to kneeling: ${this.health}/${this.maxHealth}`);
                         this.state = "kneeling";
                     }
                 }
                 
                 // Handle death - only after health reaches 0
                 if (this.health <= 0 && this.state !== "falling" && this.state !== "dead") {
                     console.log("Starting death animation");
                     this.state = "falling";
                     this.fallAngle = 0;
                     this.stopAnimation(); // Stop body animations
                     
                     // Create dramatic death scatter effect
                     this.createDeathScatterEffect();
                 }
                 
                 // Continue death animation
                 if (this.state === "falling") {
                     this.fallAngle += 1.5; // Slower rotation
                     this.updatePosition(); // Use updatePosition for consistent transform handling
                     if (this.fallAngle >= 90) {
                         this.state = "dead";
                         this.element.style.opacity = "0.3";
                     }
                 }
                 
                 // Update animation if state changed
                 if (prevState !== this.state || this.animationNeedsUpdate) {
                     console.log(`Animation update: ${prevState} -> ${this.state}`);
                     this.updateAnimation();
                     this.updatePosition(); // Update rotation when state changes
                     this.animationNeedsUpdate = false;
                 }
                 
                 // Movement (slower when wounded) - don't move when falling/dead
                 if (this.isMoving && this.state !== "dead" && this.state !== "falling") {
                     let speedMultiplier = 1;
                     if (this.state === "crawling") speedMultiplier = 0.2;
                     else if (this.state === "kneeling") speedMultiplier = 0.5;
                     
                     this.x += this.vx * speedMultiplier;
                     this.x = Math.max(50, Math.min(canvas.width - 50, this.x));
                     this.updatePosition();
                 }
                 
                 // Lifetime check
                 if (this.age > this.lifetime) {
                     this.active = false;
                     this.clearAnimations();
                     if (this.element) {
                         this.element.remove();
                     }
                 }
             }
            
            isHit(mouseX, mouseY) {
                if (!this.active) return false;
                const distance = Math.sqrt((mouseX - this.x - 30) ** 2 + (mouseY - this.y - 35) ** 2);
                return distance < 35;
            }
            
                         hit() {
                 if (this.state === "dead" || this.state === "falling") return;
                 
                 // Fixed damage of 1 per hit for predictable progression
                 this.health -= 1;
                 
                 console.log(`Hit! Health: ${this.health}/${this.maxHealth}, State: ${this.state}`);
                 
                 // Create hit effect
                 createHitEffect(this.x + 30, this.y + 35);
                 
                 // Update health bar
                 this.updateHealthBar();
                 
                 // Force animation update
                 this.animationNeedsUpdate = true;
                 
                 // Award points
                 score += 2;
                 if (this.health <= 0) {
                     score += this.isMoving ? 20 : 10;
                 }
                 
                 updateScore();
             }
        }
        
        // Particle system (remains canvas-based for effects)
        class Particle {
            constructor(x, y, vx, vy, color, life = 80) {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.color = color;
                this.life = life;
                this.maxLife = life;
                this.size = Math.random() * 8 + 4;
                this.gravity = 0.15;
            }
            
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += this.gravity;
                this.life--;
                
                // Add some air resistance
                this.vx *= 0.98;
                this.vy *= 0.98;
            }
            
            draw(ctx) {
                const alpha = this.life / this.maxLife;
                ctx.globalAlpha = alpha;
                
                // Outer glow
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size + 2, 0, Math.PI * 2);
                ctx.fill();
                
                // Main bubble
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                
                // Bright highlight
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.beginPath();
                ctx.arc(this.x - this.size * 0.3, this.y - this.size * 0.3, this.size * 0.3, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.globalAlpha = 1;
            }
        }
        
        function createHitEffect(x, y) {
            // Blood splash effect - only red colors
            const bloodColors = [
                '#FF0000', '#CC0000', '#AA0000', '#880000', 
                '#FF3333', '#DD1111', '#BB0000'
            ];
            
            for (let i = 0; i < 18; i++) {
                const angle = (Math.PI * 2 * i) / 18 + Math.random() * 0.5;
                const speed = Math.random() * 4 + 2;
                const vx = Math.cos(angle) * speed;
                const vy = Math.sin(angle) * speed - Math.random() * 2;
                const color = bloodColors[Math.floor(Math.random() * bloodColors.length)];
                
                particles.push(new Particle(x, y, vx, vy, color));
            }
        }
        
        function createMuzzleFlash(x, y) {
            const weapon = weapons[currentWeapon];
            const particleCount = weapon.pellets === 5 ? 8 : 4;
            
            for (let i = 0; i < particleCount; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 2 + 1;
                const vx = Math.cos(angle) * speed;
                const vy = Math.sin(angle) * speed;
                
                particles.push(new Particle(x, y, vx, vy, '#FFA500', 20));
            }
        }
        
                 function spawnTarget() {
             const x = Math.random() * (canvas.width - 100) + 50;
             const y = Math.random() * (canvas.height - 200) + 100;
             const scale = 0.8 + Math.random() * 0.4;
             
             const target = new SVGStickman(x, y, scale);
             targets.push(target);
             console.log(`Spawned target with ${target.health} health`);
         }
        
        function drawBackground() {
            // Sky gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(0.7, '#E0F6FF');
            gradient.addColorStop(1, '#98FB98');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Clouds
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            for (let i = 0; i < 5; i++) {
                const x = (i * 200) + Math.sin(Date.now() * 0.001 + i) * 20;
                const y = 50 + i * 20;
                drawCloud(x, y);
            }
        }
        
        function drawCloud(x, y) {
            ctx.beginPath();
            ctx.arc(x, y, 20, 0, Math.PI * 2);
            ctx.arc(x + 25, y, 30, 0, Math.PI * 2);
            ctx.arc(x + 50, y, 20, 0, Math.PI * 2);
            ctx.arc(x + 15, y - 15, 25, 0, Math.PI * 2);
            ctx.arc(x + 35, y - 15, 25, 0, Math.PI * 2);
            ctx.fill();
        }
        
        function drawCrosshair() {
            const weapon = weapons[currentWeapon];
            ctx.strokeStyle = weapon.color;
            ctx.lineWidth = 3;
            ctx.setLineDash([5, 5]);
            
            // Crosshair lines
            ctx.beginPath();
            ctx.moveTo(mouseX - 20, mouseY);
            ctx.lineTo(mouseX + 20, mouseY);
            ctx.moveTo(mouseX, mouseY - 20);
            ctx.lineTo(mouseX, mouseY + 20);
            ctx.stroke();
            
            // Center dot
            ctx.setLineDash([]);
            ctx.fillStyle = weapon.color;
            ctx.beginPath();
            ctx.arc(mouseX, mouseY, 3, 0, Math.PI * 2);
            ctx.fill();
        }
        
        function gameLoop() {
            if (!gameActive) return;
            
            // Clear canvas
            drawBackground();
            
            // Update and draw particles
            particles = particles.filter(particle => {
                particle.update();
                if (particle.life > 0) {
                    particle.draw(ctx);
                    return true;
                }
                return false;
            });
            
            // Update targets (SVG handles the drawing)
            targets = targets.filter(target => {
                target.update();
                return target.active;
            });
            
            // Draw crosshair
            drawCrosshair();
            
            // Spawn new targets
            if (Math.random() < 0.02 && targets.length < 8) {
                spawnTarget();
            }
            
            animationId = requestAnimationFrame(gameLoop);
        }
        
        function startGame() {
            gameActive = true;
            score = 0;
            targets = [];
            particles = [];
            currentWeapon = 'pistol';
            lastShotTime = 0;
            
            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            
            updateScore();
            updateWeaponButtons();
            
            // Start game timer
            gameTimer = setTimeout(() => {
                endGame();
            }, 60000); // 60 seconds
            
            gameLoop();
        }
        
        function endGame() {
            gameActive = false;
            clearTimeout(gameTimer);
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            
            // Clean up SVG elements
            targets.forEach(target => {
                if (target.element) {
                    target.element.remove();
                }
            });
            targets = [];
            
            document.getElementById('finalScore').textContent = `Final Score: ${score}`;
            gameOverScreen.style.display = 'flex';
            
            // Load and display high scores
            displayHighScores();
        }
        
        function restartGame() {
            const playerName = document.getElementById('playerName').value.trim() || 'Anonymous';
            saveHighScore(playerName, score);
            startGame();
        }
        
        function updateScore() {
            scoreDisplay.textContent = score;
        }
        
        function selectWeapon(weaponName) {
            currentWeapon = weaponName;
            updateWeaponButtons();
        }
        
        function updateWeaponButtons() {
            document.querySelectorAll('.weapon-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.weapon === currentWeapon);
            });
        }
        
        function saveHighScore(name, score) {
            let highScores = JSON.parse(localStorage.getItem('shootingGalleryHighScores') || '[]');
            highScores.push({ name, score, date: new Date().toLocaleDateString() });
            highScores.sort((a, b) => b.score - a.score);
            highScores = highScores.slice(0, 5); // Keep top 5
            localStorage.setItem('shootingGalleryHighScores', JSON.stringify(highScores));
        }
        
        function displayHighScores() {
            const highScores = JSON.parse(localStorage.getItem('shootingGalleryHighScores') || '[]');
            const highScoresDiv = document.getElementById('highScores');
            
            if (highScores.length === 0) {
                highScoresDiv.innerHTML = '<h3>🏆 High Scores</h3><p>No scores yet!</p>';
                return;
            }
            
            let html = '<h3>🏆 High Scores</h3>';
            highScores.forEach((score, index) => {
                html += `<div>${index + 1}. ${score.name}: ${score.score}</div>`;
            });
            
            highScoresDiv.innerHTML = html;
        }
        
        // Event Listeners
        document.querySelectorAll('.weapon-btn').forEach(btn => {
            btn.addEventListener('click', () => selectWeapon(btn.dataset.weapon));
        });
        
        canvas.addEventListener('mousemove', (event) => {
            const rect = canvas.getBoundingClientRect();
            mouseX = event.clientX - rect.left;
            mouseY = event.clientY - rect.top;
        });
        
        canvas.addEventListener('click', (event) => {
            if (!gameActive) return;
            
            const currentTime = Date.now();
            const weapon = weapons[currentWeapon];
            
            // Check cooldown
            if (currentTime - lastShotTime < weapon.cooldown) return;
            lastShotTime = currentTime;
            
            const rect = canvas.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const clickY = event.clientY - rect.top;
            
            // Create muzzle flash
            createMuzzleFlash(mouseX, mouseY);
            
            // Handle shotgun pellets
            const shots = weapon.pellets || 1;
            
            for (let shot = 0; shot < shots; shot++) {
                let targetX = clickX;
                let targetY = clickY;
                
                // Add spread for shotgun
                if (currentWeapon === 'shotgun') {
                    targetX += (Math.random() - 0.5) * 60;
                    targetY += (Math.random() - 0.5) * 60;
                }
                
                // Check hits
                for (let target of targets) {
                    if (target.isHit(targetX, targetY)) {
                        target.hit();
                        break;
                    }
                }
            }
        });
        
        // Keyboard controls
        document.addEventListener('keydown', (event) => {
            if (!gameActive) return;
            
            switch(event.key) {
                case '1': selectWeapon('pistol'); break;
                case '2': selectWeapon('shotgun'); break;
                case '3': selectWeapon('rifle'); break;
                case '4': selectWeapon('machineGun'); break;
            }
        });
        
        // Prevent context menu
        canvas.addEventListener('contextmenu', (e) => e.preventDefault());
        
        // Initialize
        updateWeaponButtons();
        drawBackground();
        
        // Show welcome message
        ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
        ctx.font = 'bold 24px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('🎯 Ultra Smooth SVG Stickman Gallery', canvas.width / 2, canvas.height / 2 - 20);
        ctx.font = '16px Arial';
        ctx.fillText('Professional keyframe animations powered by SVG', canvas.width / 2, canvas.height / 2 + 10);
        ctx.fillText('Click "Start Game" to experience buttery-smooth motion!', canvas.width / 2, canvas.height / 2 + 40);
    </script>
</body>
</html> 